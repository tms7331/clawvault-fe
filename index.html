<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Savings Agent - Portfolio Tracker</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a0f;
    --card: #13131a;
    --card-border: #1e1e2e;
    --accent: #3b82f6;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --bond: #a78bfa;
    --text: #e2e8f0;
    --muted: #94a3b8;
    --mono: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
    --sans: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }

  a { color: var(--accent); text-decoration: none; }
  a:hover { text-decoration: underline; }

  .container { max-width: 960px; margin: 0 auto; padding: 0 20px; }

  header {
    border-bottom: 1px solid var(--card-border);
    padding: 20px 0;
  }
  .header-inner {
    display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;
  }
  .header-title { display: flex; align-items: center; gap: 10px; }
  .header-title h1 { font-size: 1.3rem; font-weight: 700; letter-spacing: -0.02em; }
  .dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--success); box-shadow: 0 0 8px var(--success);
  }
  .dot.error { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
  .agent-address { font-family: var(--mono); font-size: 0.82rem; color: var(--muted); }

  .section { margin-top: 28px; }
  .section-label {
    font-size: 0.72rem; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--muted); margin-bottom: 10px;
  }
  .card {
    background: var(--card); border: 1px solid var(--card-border);
    border-radius: 12px; padding: 24px;
  }

  .metrics-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
  .metric-box {
    background: rgba(255,255,255,0.03); border: 1px solid var(--card-border);
    border-radius: 10px; padding: 16px; text-align: center;
  }
  .metric-box .label {
    font-size: 0.75rem; color: var(--muted); text-transform: uppercase;
    letter-spacing: 0.05em; margin-bottom: 6px;
  }
  .metric-box .value { font-size: 1.5rem; font-weight: 700; font-family: var(--mono); }
  .metric-box .value.positive { color: var(--success); }
  .metric-box .value.negative { color: var(--danger); }
  .metric-box .sub { font-size: 0.7rem; color: var(--muted); margin-top: 4px; }

  .balances-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
  .balance-card { display: flex; align-items: center; gap: 16px; }
  .balance-icon {
    width: 44px; height: 44px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 0.85rem; flex-shrink: 0;
  }
  .balance-icon.eth { background: linear-gradient(135deg, #627eea, #3b5fc0); color: #fff; }
  .balance-icon.usdc { background: linear-gradient(135deg, #2775ca, #1a5bb5); color: #fff; }
  .balance-info .token-name { font-size: 0.8rem; color: var(--muted); }
  .balance-info .token-amount { font-size: 1.25rem; font-weight: 700; font-family: var(--mono); }
  .balance-info .token-usd { font-size: 0.8rem; color: var(--muted); font-family: var(--mono); }

  .hedge-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
  .hedge-card { text-align: center; }
  .hedge-card .token-symbol {
    font-size: 0.8rem; font-weight: 700; letter-spacing: 0.04em;
    color: var(--accent); margin-bottom: 4px;
  }
  .hedge-card .token-balance { font-size: 1.1rem; font-weight: 700; font-family: var(--mono); }
  .hedge-card .token-value { font-size: 0.78rem; color: var(--muted); font-family: var(--mono); }
  .hedge-card .token-price { font-size: 0.68rem; color: var(--muted); margin-top: 2px; }

  .vault-info { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
  .vault-stat { text-align: center; }
  .vault-stat .label { font-size: 0.75rem; color: var(--muted); margin-bottom: 4px; }
  .vault-stat .value { font-size: 1.1rem; font-weight: 700; font-family: var(--mono); }
  .vault-stat .sub { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

  .yield-card { position: relative; overflow: hidden; }
  .yield-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--success));
    border-radius: 12px 12px 0 0;
  }

  /* Landing page */
  .landing { text-align: center; padding: 80px 20px; }
  .landing h2 { font-size: 2rem; font-weight: 700; margin-bottom: 8px; }
  .landing p { color: var(--muted); margin-bottom: 32px; max-width: 500px; margin-inline: auto; }
  .landing-form { display: flex; gap: 12px; max-width: 580px; margin: 0 auto; }
  .landing-form input {
    flex: 1; background: var(--card); border: 1px solid var(--card-border);
    border-radius: 10px; padding: 14px 16px; color: var(--text);
    font-family: var(--mono); font-size: 0.9rem; outline: none;
  }
  .landing-form input:focus { border-color: var(--accent); }
  .landing-form input::placeholder { color: var(--muted); }
  .landing-form button {
    background: var(--accent); color: #fff; border: none; border-radius: 10px;
    padding: 14px 28px; font-weight: 600; cursor: pointer; white-space: nowrap;
    font-size: 0.9rem;
  }
  .landing-form button:hover { opacity: 0.9; }
  .landing-hint { margin-top: 16px; font-size: 0.75rem; color: var(--muted); }
  .landing-hint code {
    background: var(--card); padding: 2px 6px; border-radius: 4px;
    font-family: var(--mono); font-size: 0.72rem;
  }

  .config-toggle {
    margin-top: 24px; font-size: 0.8rem; color: var(--muted); cursor: pointer;
  }
  .config-toggle:hover { color: var(--accent); }
  .config-panel {
    display: none; margin-top: 16px; text-align: left; max-width: 580px;
    margin-inline: auto; background: var(--card); border: 1px solid var(--card-border);
    border-radius: 10px; padding: 20px;
  }
  .config-panel.show { display: block; }
  .config-panel label {
    display: block; font-size: 0.75rem; color: var(--muted); margin-bottom: 4px; margin-top: 12px;
  }
  .config-panel label:first-child { margin-top: 0; }
  .config-panel input {
    width: 100%; background: var(--bg); border: 1px solid var(--card-border);
    border-radius: 6px; padding: 8px 10px; color: var(--text);
    font-family: var(--mono); font-size: 0.78rem; outline: none;
  }
  .config-panel input:focus { border-color: var(--accent); }

  .loading-overlay {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; padding: 60px 20px; text-align: center;
  }
  .spinner {
    width: 36px; height: 36px; border: 3px solid var(--card-border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.8s linear infinite; margin-bottom: 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { color: var(--muted); font-size: 0.9rem; }
  .error-text { color: var(--danger); font-size: 0.85rem; margin-top: 8px; }

  footer {
    margin-top: 40px; padding: 20px 0; border-top: 1px solid var(--card-border);
    text-align: center; font-size: 0.75rem; color: var(--muted);
  }
  footer .refresh-timer { margin-top: 6px; font-family: var(--mono); font-size: 0.72rem; }

  .hash-link { font-family: var(--mono); font-size: 0.8rem; color: var(--accent); }

  @media (max-width: 768px) {
    .metrics-row { grid-template-columns: 1fr; }
    .balances-grid { grid-template-columns: 1fr; }
    .hedge-grid { grid-template-columns: 1fr; }
    .vault-info { grid-template-columns: repeat(2, 1fr); }
    .landing-form { flex-direction: column; }
    .header-inner { flex-direction: column; align-items: flex-start; }
  }
  @media (max-width: 480px) {
    .vault-info { grid-template-columns: 1fr; }
    .container { padding: 0 12px; }
    .card { padding: 16px; }
  }
</style>
</head>
<body>

<header>
  <div class="container header-inner">
    <div class="header-title">
      <div class="dot" id="status-dot"></div>
      <h1>Savings Agent</h1>
    </div>
    <div id="agent-address" class="agent-address"></div>
  </div>
</header>

<main class="container">

  <!-- Landing page (shown when no wallet param) -->
  <div id="landing" class="landing" style="display:none;">
    <h2>Portfolio Tracker</h2>
    <p>Enter your wallet address to view your Savings Agent portfolio, vault deposits, hedge token holdings, and pending yield - all read directly from the blockchain.</p>
    <div class="landing-form">
      <input type="text" id="wallet-input" placeholder="0x... wallet address" spellcheck="false">
      <button onclick="navigateToWallet()">View Portfolio</button>
    </div>
    <div class="landing-hint">
      Or pass via URL: <code>?wallet=0x...&rpc=http://127.0.0.1:8545</code>
    </div>
    <div class="config-toggle" onclick="toggleConfig()">Advanced: Configure contract addresses</div>
    <div id="config-panel" class="config-panel">
      <label>RPC URL</label>
      <input type="text" id="cfg-rpc" placeholder="http://127.0.0.1:8545">
      <label>USDC Address</label>
      <input type="text" id="cfg-usdc" placeholder="0x...">
      <label>SavingsVault Address</label>
      <input type="text" id="cfg-vault" placeholder="0x...">
      <label>HedgeRouter Address</label>
      <input type="text" id="cfg-router" placeholder="0x...">
      <label>RE-HEDGE Address</label>
      <input type="text" id="cfg-rehedge" placeholder="0x...">
      <label>SP-HEDGE Address</label>
      <input type="text" id="cfg-sphedge" placeholder="0x...">
      <label>BOND-HEDGE Address</label>
      <input type="text" id="cfg-bondhedge" placeholder="0x...">
    </div>
  </div>

  <!-- Loading state -->
  <div id="loading-state" class="loading-overlay" style="display:none;">
    <div class="spinner"></div>
    <div class="loading-text">Reading onchain data...</div>
    <div class="error-text" id="loading-error" style="display:none;"></div>
  </div>

  <!-- Dashboard (shown when data is loaded) -->
  <div id="dashboard" style="display:none;">

    <!-- Vault Deposit & Yield -->
    <div class="section">
      <div class="section-label">Vault Position</div>
      <div class="card yield-card">
        <div class="metrics-row">
          <div class="metric-box">
            <div class="label">Deposited</div>
            <div class="value" id="vault-deposits">--</div>
            <div class="sub">USDC</div>
          </div>
          <div class="metric-box">
            <div class="label">Pending Yield</div>
            <div class="value positive" id="pending-yield">--</div>
            <div class="sub">USDC (unharvested)</div>
          </div>
          <div class="metric-box">
            <div class="label">Total Portfolio</div>
            <div class="value" id="total-value">--</div>
            <div class="sub">USDC equivalent</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Wallet Balances -->
    <div class="section">
      <div class="section-label">Wallet Balances</div>
      <div class="balances-grid">
        <div class="card balance-card">
          <div class="balance-icon eth">ETH</div>
          <div class="balance-info">
            <div class="token-name">Ether</div>
            <div class="token-amount" id="eth-amount">--</div>
            <div class="token-usd" id="eth-usd">--</div>
          </div>
        </div>
        <div class="card balance-card">
          <div class="balance-icon usdc">USDC</div>
          <div class="balance-info">
            <div class="token-name">USD Coin</div>
            <div class="token-amount" id="usdc-amount">--</div>
            <div class="token-usd" id="usdc-usd">--</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hedge Token Holdings -->
    <div class="section">
      <div class="section-label">Hedge Token Holdings</div>
      <div class="hedge-grid">
        <div class="card hedge-card">
          <div class="token-symbol">RE-HEDGE</div>
          <div class="token-balance" id="re-balance">--</div>
          <div class="token-value" id="re-value">--</div>
          <div class="token-price" id="re-price">--</div>
        </div>
        <div class="card hedge-card">
          <div class="token-symbol" style="color:var(--warning);">SP-HEDGE</div>
          <div class="token-balance" id="sp-balance">--</div>
          <div class="token-value" id="sp-value">--</div>
          <div class="token-price" id="sp-price">--</div>
        </div>
        <div class="card hedge-card">
          <div class="token-symbol" style="color:var(--bond);">BOND-HEDGE</div>
          <div class="token-balance" id="bond-balance">--</div>
          <div class="token-value" id="bond-value">--</div>
          <div class="token-price" id="bond-price">--</div>
        </div>
      </div>
    </div>

    <!-- Vault Parameters -->
    <div class="section">
      <div class="section-label">Vault Parameters</div>
      <div class="card">
        <div class="vault-info">
          <div class="vault-stat">
            <div class="label">Annual Yield</div>
            <div class="value positive" id="annual-yield">--</div>
          </div>
          <div class="vault-stat">
            <div class="label">Management Fee</div>
            <div class="value" id="mgmt-fee">--</div>
          </div>
          <div class="vault-stat">
            <div class="label">Agent Wallet</div>
            <div class="value" id="agent-wallet" style="font-size:0.8rem;">--</div>
          </div>
          <div class="vault-stat">
            <div class="label">Vault USDC Balance</div>
            <div class="value" id="vault-balance">--</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</main>

<footer>
  <div class="container">
    <div>Powered by <a href="https://openclaw.ai" target="_blank" rel="noopener">OpenClaw</a> &middot; ERC-8021 Builder Codes &middot; Base</div>
    <div class="refresh-timer" id="refresh-timer"></div>
  </div>
</footer>

<script>
(function() {
  'use strict';

  // ---------------------------------------------------------------------------
  // Keccak-256 (minimal, for computing function selectors)
  // Based on the reference implementation. We only need 4-byte selectors.
  // ---------------------------------------------------------------------------

  const RC = [
    0x0001n, 0x8082n, 0x808an, 0x80008000n, 0x808bn, 0x80000001n, 0x80008081n,
    0x8009n, 0x8an, 0x88n, 0x80008009n, 0x8000000an, 0x8000808bn,
    0x800000000000008bn, 0x8000000000008089n, 0x8000000000008003n,
    0x8000000000008002n, 0x8000000000000080n, 0x800an, 0x800000008000000an,
    0x8000000080008081n, 0x8000000000008080n, 0x80000001n, 0x8000000080008008n,
  ];

  const ROTC = [
    1,3,6,10,15,21,28,36,45,55,2,14,27,41,56,8,25,43,62,18,39,61,20,44
  ];

  const PI = [
    10,7,11,17,18,3,5,16,8,21,24,4,15,23,19,13,12,2,20,14,22,9,6,1
  ];

  function keccakF(state) {
    for (let round = 0; round < 24; round++) {
      // Theta
      const C = new Array(5);
      for (let x = 0; x < 5; x++)
        C[x] = state[x] ^ state[x+5] ^ state[x+10] ^ state[x+15] ^ state[x+20];
      for (let x = 0; x < 5; x++) {
        const t = C[(x+4)%5] ^ rot64(C[(x+1)%5], 1);
        for (let y = 0; y < 25; y += 5) state[x+y] ^= t;
      }
      // Rho + Pi
      let last = state[1];
      for (let i = 0; i < 24; i++) {
        const j = PI[i];
        const tmp = state[j];
        state[j] = rot64(last, ROTC[i]);
        last = tmp;
      }
      // Chi
      for (let y = 0; y < 25; y += 5) {
        const t = [state[y], state[y+1], state[y+2], state[y+3], state[y+4]];
        for (let x = 0; x < 5; x++)
          state[y+x] = t[x] ^ ((~t[(x+1)%5]) & t[(x+2)%5]);
      }
      // Iota
      state[0] ^= RC[round];
    }
  }

  function rot64(x, n) {
    x = BigInt.asUintN(64, x);
    return BigInt.asUintN(64, (x << BigInt(n)) | (x >> BigInt(64 - n)));
  }

  function keccak256(data) {
    const rate = 136; // 1088 bits / 8
    const state = new Array(25).fill(0n);
    // Pad
    const padded = new Uint8Array(Math.ceil((data.length + 1) / rate) * rate);
    padded.set(data);
    padded[data.length] = 0x01;
    padded[padded.length - 1] |= 0x80;
    // Absorb
    for (let off = 0; off < padded.length; off += rate) {
      for (let i = 0; i < rate; i += 8) {
        const lane = (off + i) < padded.length ? laneFromBytes(padded, off + i) : 0n;
        state[i >> 3] ^= lane;
      }
      keccakF(state);
    }
    // Squeeze 32 bytes
    const out = new Uint8Array(32);
    for (let i = 0; i < 4; i++) {
      const v = state[i];
      for (let b = 0; b < 8; b++) out[i*8+b] = Number((v >> BigInt(b*8)) & 0xffn);
    }
    return out;
  }

  function laneFromBytes(buf, off) {
    let v = 0n;
    for (let i = 0; i < 8 && (off+i) < buf.length; i++)
      v |= BigInt(buf[off+i]) << BigInt(i*8);
    return v;
  }

  function selector(sig) {
    const bytes = new TextEncoder().encode(sig);
    const hash = keccak256(bytes);
    return '0x' + Array.from(hash.slice(0, 4)).map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // ---------------------------------------------------------------------------
  // Function selectors
  // ---------------------------------------------------------------------------

  const SEL = {
    balanceOf:        selector('balanceOf(address)'),
    users:            selector('users(address)'),
    pendingYield:     selector('pendingYield(address)'),
    getPrice:         selector('getPrice(address)'),
    agentWallet:      selector('agentWallet()'),
    managementFeeBps: selector('managementFeeBps()'),
    annualYieldBps:   selector('annualYieldBps()'),
  };

  // ---------------------------------------------------------------------------
  // Config: default contract addresses (update after deployment)
  // ---------------------------------------------------------------------------

  const DEFAULTS = {
    rpc:       'http://127.0.0.1:8545',
    usdc:      '0x0000000000000000000000000000000000000000',
    vault:     '0x0000000000000000000000000000000000000000',
    router:    '0x0000000000000000000000000000000000000000',
    rehedge:   '0x0000000000000000000000000000000000000000',
    sphedge:   '0x0000000000000000000000000000000000000000',
    bondhedge: '0x0000000000000000000000000000000000000000',
  };

  // ---------------------------------------------------------------------------
  // URL params
  // ---------------------------------------------------------------------------

  function getParams() {
    const p = new URLSearchParams(window.location.search);
    return {
      wallet:    p.get('wallet') || '',
      rpc:       p.get('rpc')       || DEFAULTS.rpc,
      usdc:      p.get('usdc')      || DEFAULTS.usdc,
      vault:     p.get('vault')     || DEFAULTS.vault,
      router:    p.get('router')    || DEFAULTS.router,
      rehedge:   p.get('rehedge')   || DEFAULTS.rehedge,
      sphedge:   p.get('sphedge')   || DEFAULTS.sphedge,
      bondhedge: p.get('bondhedge') || DEFAULTS.bondhedge,
    };
  }

  // ---------------------------------------------------------------------------
  // Helpers
  // ---------------------------------------------------------------------------

  function padAddress(addr) {
    return '0x' + addr.replace('0x', '').toLowerCase().padStart(64, '0');
  }

  function hexToBI(hex) {
    if (!hex || hex === '0x') return 0n;
    return BigInt(hex);
  }

  function formatUsdc(raw) {
    const n = Number(raw) / 1e6;
    return n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function formatEth(wei) {
    const whole = wei / (10n ** 18n);
    const frac = wei % (10n ** 18n);
    return whole.toString() + '.' + frac.toString().padStart(18, '0').slice(0, 6);
  }

  function formatHedge(raw) {
    const n = Number(raw) / 1e18;
    return n.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
  }

  function truncAddr(addr) {
    if (!addr || addr.length < 12) return addr || '--';
    return addr.slice(0, 6) + '...' + addr.slice(-4);
  }

  // ---------------------------------------------------------------------------
  // JSON-RPC calls
  // ---------------------------------------------------------------------------

  let rpcUrl = '';
  let rpcId = 1;

  async function rpcCall(method, params) {
    const res = await fetch(rpcUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jsonrpc: '2.0', method, params, id: rpcId++ }),
    });
    const json = await res.json();
    if (json.error) throw new Error(json.error.message || JSON.stringify(json.error));
    return json.result;
  }

  async function ethGetBalance(addr) {
    const result = await rpcCall('eth_getBalance', [addr, 'latest']);
    return hexToBI(result);
  }

  async function ethCall(to, data) {
    const result = await rpcCall('eth_call', [{ to, data }, 'latest']);
    return result;
  }

  async function callBalanceOf(token, wallet) {
    const data = SEL.balanceOf + padAddress(wallet).slice(2);
    const result = await ethCall(token, data);
    return hexToBI(result);
  }

  async function callUsers(vault, wallet) {
    const data = SEL.users + padAddress(wallet).slice(2);
    const result = await ethCall(vault, data);
    // Returns (uint256 deposits, uint256 pendingYield, uint256 lastDripTimestamp)
    // Each uint256 is 32 bytes = 64 hex chars
    const hex = result.slice(2); // remove 0x
    return {
      deposits: hexToBI('0x' + hex.slice(0, 64)),
      pendingYield: hexToBI('0x' + hex.slice(64, 128)),
      lastDripTimestamp: hexToBI('0x' + hex.slice(128, 192)),
    };
  }

  async function callPendingYield(vault, wallet) {
    const data = SEL.pendingYield + padAddress(wallet).slice(2);
    const result = await ethCall(vault, data);
    return hexToBI(result);
  }

  async function callGetPrice(router, token) {
    const data = SEL.getPrice + padAddress(token).slice(2);
    const result = await ethCall(router, data);
    return hexToBI(result);
  }

  async function callNoArgs(contract, sel) {
    const result = await ethCall(contract, sel);
    return result;
  }

  // ---------------------------------------------------------------------------
  // Fetch all data
  // ---------------------------------------------------------------------------

  async function fetchAllData(params) {
    const w = params.wallet;

    const [
      ethBal,
      usdcBal,
      userInfo,
      pendingYieldVal,
      reBal, spBal, bondBal,
      rePrice, spPrice, bondPrice,
      agentWalletHex,
      feeBpsHex,
      yieldBpsHex,
      vaultUsdcBal,
    ] = await Promise.all([
      ethGetBalance(w),
      callBalanceOf(params.usdc, w),
      callUsers(params.vault, w),
      callPendingYield(params.vault, w),
      callBalanceOf(params.rehedge, w),
      callBalanceOf(params.sphedge, w),
      callBalanceOf(params.bondhedge, w),
      callGetPrice(params.router, params.rehedge),
      callGetPrice(params.router, params.sphedge),
      callGetPrice(params.router, params.bondhedge),
      callNoArgs(params.vault, SEL.agentWallet),
      callNoArgs(params.vault, SEL.managementFeeBps),
      callNoArgs(params.vault, SEL.annualYieldBps),
      callBalanceOf(params.usdc, params.vault),
    ]);

    // Compute hedge token USD values
    // hedgeValue = balance (18 dec) * price (6 dec) / 1e18 => result in USDC 6 dec
    const reValueUsdc = (reBal * rePrice) / (10n ** 18n);
    const spValueUsdc = (spBal * spPrice) / (10n ** 18n);
    const bondValueUsdc = (bondBal * bondPrice) / (10n ** 18n);

    const totalHedgeUsdc = reValueUsdc + spValueUsdc + bondValueUsdc;
    const totalPortfolio = userInfo.deposits + pendingYieldVal + totalHedgeUsdc + usdcBal;

    const agentAddr = '0x' + agentWalletHex.slice(26); // last 20 bytes
    const feeBps = Number(hexToBI(feeBpsHex));
    const yieldBps = Number(hexToBI(yieldBpsHex));

    return {
      ethBal, usdcBal,
      deposits: userInfo.deposits,
      pendingYield: pendingYieldVal,
      reBal, spBal, bondBal,
      rePrice, spPrice, bondPrice,
      reValueUsdc, spValueUsdc, bondValueUsdc,
      totalHedgeUsdc, totalPortfolio,
      agentAddr, feeBps, yieldBps,
      vaultUsdcBal,
    };
  }

  // ---------------------------------------------------------------------------
  // Render
  // ---------------------------------------------------------------------------

  function render(data, params) {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';

    // Header
    const dot = document.getElementById('status-dot');
    dot.classList.remove('error');
    document.getElementById('agent-address').innerHTML =
      'Viewing: <a class="hash-link" href="https://basescan.org/address/' +
      params.wallet + '" target="_blank" rel="noopener">' + truncAddr(params.wallet) + '</a>';

    // Vault position
    document.getElementById('vault-deposits').textContent = formatUsdc(data.deposits);
    document.getElementById('pending-yield').textContent = '+' + formatUsdc(data.pendingYield);
    document.getElementById('total-value').textContent = formatUsdc(data.totalPortfolio);

    // Wallet balances
    document.getElementById('eth-amount').textContent = formatEth(data.ethBal);
    const ethUsd = Number(data.ethBal) / 1e18 * 2500; // rough ETH price
    document.getElementById('eth-usd').textContent = '~$' + ethUsd.toLocaleString('en-US', { maximumFractionDigits: 2 });
    document.getElementById('usdc-amount').textContent = formatUsdc(data.usdcBal);
    document.getElementById('usdc-usd').textContent = '$' + formatUsdc(data.usdcBal);

    // Hedge tokens
    function renderHedge(prefix, bal, value, price) {
      document.getElementById(prefix + '-balance').textContent = formatHedge(bal);
      document.getElementById(prefix + '-value').textContent = '$' + formatUsdc(value);
      document.getElementById(prefix + '-price').textContent = 'Price: $' + formatUsdc(price);
    }
    renderHedge('re', data.reBal, data.reValueUsdc, data.rePrice);
    renderHedge('sp', data.spBal, data.spValueUsdc, data.spPrice);
    renderHedge('bond', data.bondBal, data.bondValueUsdc, data.bondPrice);

    // Vault parameters
    document.getElementById('annual-yield').textContent = (data.yieldBps / 100).toFixed(1) + '%';
    document.getElementById('mgmt-fee').textContent = (data.feeBps / 100).toFixed(1) + '%';
    document.getElementById('agent-wallet').innerHTML =
      '<a class="hash-link" href="https://basescan.org/address/' +
      data.agentAddr + '" target="_blank" rel="noopener">' + truncAddr(data.agentAddr) + '</a>';
    document.getElementById('vault-balance').textContent = formatUsdc(data.vaultUsdcBal);
  }

  // ---------------------------------------------------------------------------
  // Refresh loop
  // ---------------------------------------------------------------------------

  const REFRESH_SEC = 30;
  let countdown = REFRESH_SEC;
  let currentParams = null;

  async function refresh() {
    if (!currentParams || !currentParams.wallet) return;
    try {
      const data = await fetchAllData(currentParams);
      render(data, currentParams);
    } catch (err) {
      console.warn('Refresh failed:', err);
      const dot = document.getElementById('status-dot');
      dot.classList.add('error');
    }
  }

  function tick() {
    countdown--;
    if (countdown <= 0) {
      countdown = REFRESH_SEC;
      refresh();
    }
    const el = document.getElementById('refresh-timer');
    if (el) el.textContent = 'Auto-refresh in ' + countdown + 's';
  }

  // ---------------------------------------------------------------------------
  // Navigation
  // ---------------------------------------------------------------------------

  window.navigateToWallet = function() {
    const wallet = document.getElementById('wallet-input').value.trim();
    if (!wallet || !wallet.startsWith('0x')) {
      alert('Please enter a valid wallet address starting with 0x');
      return;
    }
    const p = new URLSearchParams();
    p.set('wallet', wallet);

    // Include advanced config if set
    const fields = ['rpc', 'usdc', 'vault', 'router', 'rehedge', 'sphedge', 'bondhedge'];
    for (const f of fields) {
      const val = document.getElementById('cfg-' + f).value.trim();
      if (val) p.set(f, val);
    }

    window.location.search = p.toString();
  };

  window.toggleConfig = function() {
    document.getElementById('config-panel').classList.toggle('show');
  };

  // ---------------------------------------------------------------------------
  // Init
  // ---------------------------------------------------------------------------

  document.addEventListener('DOMContentLoaded', async function() {
    const params = getParams();

    if (!params.wallet) {
      document.getElementById('landing').style.display = 'block';
      // Pre-fill config fields with defaults
      document.getElementById('cfg-rpc').placeholder = DEFAULTS.rpc;
      return;
    }

    // Show loading
    document.getElementById('loading-state').style.display = 'flex';
    rpcUrl = params.rpc;
    currentParams = params;

    try {
      const data = await fetchAllData(params);
      render(data, params);
      // Start refresh timer
      setInterval(tick, 1000);
    } catch (err) {
      console.error('Failed to load data:', err);
      const errEl = document.getElementById('loading-error');
      errEl.style.display = 'block';
      errEl.textContent = 'Failed to read from chain: ' + err.message;
      document.getElementById('status-dot').classList.add('error');
    }
  });

  // Allow Enter key on wallet input
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && document.activeElement && document.activeElement.id === 'wallet-input') {
      navigateToWallet();
    }
  });

})();
</script>

</body>
</html>
